var TrNgGrid;(function(TrNgGrid){var tableDirective="trNgGrid";var headerDirective="trNgGridHeader";var headerDirectiveAttribute="tr-ng-grid-header";var bodyDirective="trNgGridBody";var bodyDirectiveAttribute="tr-ng-grid-body";var footerDirective="trNgGridFooter";var footerDirectiveAttribute="tr-ng-grid-footer";var globalFilterDirective="trNgGridGlobalFilter";var globalFilterDirectiveAttribute="tr-ng-grid-global-filter";var pagerDirective="trNgGridPager";var pagerDirectiveAttribute="tr-ng-grid-pager";var columnDirective="trNgGridColumn";var columnDirectiveAttribute="tr-ng-grid-column";var sortDirective="trNgGridColumnSort";var sortDirectiveAttribute="tr-ng-grid-column-sort";var filterColumnDirective="trNgGridColumnFilter";var filterColumnDirectiveAttribute="tr-ng-grid-column-filter";var rowPageItemIndexAttribute="tr-ng-grid-row-page-item-index";var tableCssClass="tr-ng-grid table table-bordered table-hover";var cellCssClass="tr-ng-cell";var cellTitleSortCssClass="";var titleCssClass="tr-ng-title";var sortCssClass="tr-ng-sort";var filterColumnCssClass="tr-ng-column-filter";var filterInputWrapperCssClass="";var sortActiveCssClass="tr-ng-sort-active";var sortInactiveCssClass="tr-ng-sort-inactive";var sortReverseCssClass="tr-ng-sort-reverse";var selectedRowCssClass="active";var footerOpsContainerCssClass="tr-ng-grid-footer form-inline";var GridController=function(){function GridController($compile,$scope,$element,$attrs,$transclude,$parse,$timeout){var _this=this;this.$compile=$compile;this.$parse=$parse;this.$timeout=$timeout;this.gridElement=$element;this.internalScope=$scope;this.scheduledRecompilationDereg=null;var scopeOptionsIdentifier="gridOptions";this.gridOptions={items:[],selectedItems:[],filterBy:null,filterByFields:{},orderBy:null,orderByReverse:false,pageItems:null,currentPage:0,totalItems:null,enableFiltering:true,enableSorting:true,enableSelections:true,enableMultiRowSelections:true,onDataRequiredDelay:1e3};this.gridOptions.onDataRequired=$attrs["onDataRequired"]?$scope.onDataRequired:null;this.gridOptions.gridColumnDefs=[];$scope[scopeOptionsIdentifier]=this.gridOptions;this.externalScope=this.internalScope.$parent;this.linkScope(this.internalScope,scopeOptionsIdentifier,$attrs);if(this.gridOptions.onDataRequired){$scope.$watchCollection("[gridOptions.filterBy, "+"gridOptions.filterByFields, "+"gridOptions.orderBy, "+"gridOptions.orderByReverse, "+"gridOptions.currentPage]",function(){if(_this.dataRequestPromise){_this.$timeout.cancel(_this.dataRequestPromise);_this.dataRequestPromise=null}_this.dataRequestPromise=_this.$timeout(function(){_this.dataRequestPromise=null;_this.gridOptions.onDataRequired(_this.gridOptions)},_this.gridOptions.onDataRequiredDelay,true)})}this.internalScope.$watch("enableMultiRowSelections",function(newValue,oldValue){if(newValue!==oldValue&&!newValue){if(_this.gridOptions.selectedItems.length>1){_this.gridOptions.selectedItems.splice(1)}}});this.internalScope.$watch("enableSelections",function(newValue,oldValue){if(newValue!==oldValue&&!newValue){_this.gridOptions.selectedItems.splice(0);_this.gridOptions.enableMultiRowSelections=false}})}GridController.prototype.setColumnOptions=function(columnIndex,columnOptions){if(columnIndex>=this.gridOptions.gridColumnDefs.length){this.gridOptions.gridColumnDefs.push({});this.setColumnOptions(columnIndex,columnOptions)}else{this.gridOptions.gridColumnDefs[columnIndex]=columnOptions}};GridController.prototype.toggleSorting=function(propertyName){if(this.gridOptions.orderBy!=propertyName){this.gridOptions.orderBy=propertyName}else{this.gridOptions.orderByReverse=!this.gridOptions.orderByReverse}};GridController.prototype.setFilter=function(propertyName,filter){if(!filter){delete this.gridOptions.filterByFields[propertyName]}else{this.gridOptions.filterByFields[propertyName]=filter}this.gridOptions.filterByFields=$.extend({},this.gridOptions.filterByFields)};GridController.prototype.toggleItemSelection=function(item){if(!this.gridOptions.enableSelections)return;var itemIndex=this.gridOptions.selectedItems.indexOf(item);if(itemIndex>=0){this.gridOptions.selectedItems.splice(itemIndex,1)}else{if(!this.gridOptions.enableMultiRowSelections){this.gridOptions.selectedItems.splice(0)}this.gridOptions.selectedItems.push(item)}};GridController.prototype.scheduleRecompilationOnAvailableItems=function(){var _this=this;if(this.scheduledRecompilationDereg||this.gridOptions.items&&this.gridOptions.items.length)return;this.scheduledRecompilationDereg=this.internalScope.$watch("items.length",function(newLength,oldLength){if(newLength>0){_this.scheduledRecompilationDereg();_this.$compile(_this.gridElement)(_this.externalScope)}})};GridController.prototype.linkScope=function(scope,scopeTargetIdentifier,attrs){var target=scope[scopeTargetIdentifier];for(var propName in target){var attributeExists=typeof attrs[propName]!="undefined"&&attrs[propName]!=null;if(attributeExists){var isArray=false;if(typeof scope[propName]!="undefined"&&scope[propName]!=null){target[propName]=scope[propName];isArray=target[propName]instanceof Array}if(!isArray){var compiledAttr=this.$parse(attrs[propName]);var dualDataBindingPossible=typeof compiledAttr!="array"&&compiledAttr&&compiledAttr.assign;if(dualDataBindingPossible){(function(propName){scope.$watch(scopeTargetIdentifier+"."+propName,function(newValue,oldValue){if(newValue!==oldValue){scope[propName]=target[propName]}});scope.$watch(propName,function(newValue,oldValue){if(newValue!==oldValue){target[propName]=scope[propName]}})})(propName)}}}}};GridController.prototype.splitByCamelCasing=function(input){var splitInput=input.split(/(?=[A-Z])/);if(splitInput.length&&splitInput[0].length){splitInput[0]=splitInput[0][0].toLocaleUpperCase()+splitInput[0].substr(1)}return splitInput.join(" ")};return GridController}();angular.module("trNgGrid",[]).directive(tableDirective,[function(){return{restrict:"A",scope:{items:"=",selectedItems:"=?",filterBy:"=?",filterByFields:"=?",orderBy:"=?",orderByReverse:"=?",pageItems:"=?",currentPage:"=?",totalItems:"=?",enableFiltering:"=?",enableSorting:"=?",enableSelections:"=?",enableMultiRowSelections:"=?",onDataRequired:"&",onDataRequiredDelay:"=?"},controller:["$compile","$scope","$element","$attrs","$transclude","$parse","$timeout",GridController],compile:function(templateElement,tAttrs){templateElement.addClass(tableCssClass);var insertFooterElement=false;var insertHeadElement=false;var tableHeadElement=templateElement.children("thead");if(tableHeadElement.length==0){tableHeadElement=$("<thead>");insertHeadElement=true}var tableHeadRowTemplate=tableHeadElement.children("tr");if(tableHeadRowTemplate.length==0){tableHeadRowTemplate=$("<tr>").appendTo(tableHeadElement)}tableHeadRowTemplate.attr(headerDirectiveAttribute,"");tableHeadRowTemplate.children("th[field-name]").attr(columnDirectiveAttribute,"");var tableBodyElement=templateElement.children("tbody");if(tableBodyElement.length===0){tableBodyElement=$("<tbody>").appendTo(templateElement)}var tableBodyRowTemplate=tableBodyElement.children("tr");if(tableBodyRowTemplate.length===0){tableBodyRowTemplate=$("<tr>").appendTo(tableBodyElement)}tableBodyElement.attr(bodyDirectiveAttribute,"");var tableFooterElement=templateElement.children("tfoot");if(tableFooterElement.length==0){tableFooterElement=$("<tfoot>");insertFooterElement=true}var tableFooterRowTemplate=tableFooterElement.children("tr");if(tableFooterRowTemplate.length==0){tableFooterRowTemplate=$("<tr>").appendTo(tableFooterElement)}if(tableFooterRowTemplate.children("td").length==0){var fullTableLengthFooterCell=$("<td>").attr("colspan","999").appendTo(tableFooterRowTemplate);var footerOpsContainer=$("<div>").attr(footerDirectiveAttribute,"").appendTo(fullTableLengthFooterCell)}if(insertHeadElement){templateElement.prepend(tableHeadElement)}if(insertFooterElement){tableFooterElement.insertBefore(tableBodyElement)}}}}]).directive(headerDirective,["$compile",function($compile){return{restrict:"A",scope:false,require:"^"+tableDirective,compile:function(templateElement,tAttrs){return{pre:function(scope,instanceElement,tAttrs,gridController){if(instanceElement.children("th").length==0){if(gridController.gridOptions.items&&gridController.gridOptions.items.length>0){for(var propName in gridController.gridOptions.items[0]){if(!propName.match(/^[_\$]/g)){var headerCellElement=$("<th>").attr(columnDirectiveAttribute,"").attr("field-name",propName).appendTo(instanceElement);$compile(headerCellElement)(scope)}}}else{gridController.scheduleRecompilationOnAvailableItems()}}}}}}}]).directive(columnDirective,["$compile",function($compile){return{restrict:"A",scope:true,require:"^"+tableDirective,compile:function(templateElement,tAttrs){var columnIndex;return{pre:function(scope,instanceElement,tAttrs,controller){var isValid=instanceElement.prop("tagName")=="TH";if(!isValid){throw"The template has an invalid header column template element. Column templates must be defined on TH elements inside THEAD/TR"}columnIndex=instanceElement.parent().children("th").index(instanceElement);if(columnIndex<0)return;scope.gridOptions=controller.gridOptions;scope.toggleSorting=function(propertyName){return controller.toggleSorting(propertyName)};scope.filter="";scope.$watch("filter",function(newValue,oldValue){if(newValue!==oldValue){controller.setFilter(scope.currentGridColumnDef.fieldName,newValue)}});var columnDefSetup=function(){scope.currentGridColumnDef.fieldName=tAttrs["fieldName"];scope.currentGridColumnDef.displayName=typeof tAttrs["displayName"]=="undefined"?controller.splitByCamelCasing(tAttrs["fieldName"]):tAttrs["displayName"],scope.currentGridColumnDef.enableFiltering=tAttrs["enableFiltering"]=="true"||typeof tAttrs["enableFiltering"]=="undefined"&&scope.gridOptions.enableFiltering;scope.currentGridColumnDef.enableSorting=tAttrs["enableSorting"]=="true"||typeof tAttrs["enableSorting"]=="undefined"&&scope.gridOptions.enableSorting;scope.currentGridColumnDef.displayAlign=tAttrs["displayAlign"];scope.currentGridColumnDef.displayFormat=tAttrs["displayFormat"];scope.currentGridColumnDef.cellWidth=tAttrs["cellWidth"];scope.currentGridColumnDef.cellHeight=tAttrs["cellHeight"]};scope.currentGridColumnDef={};columnDefSetup();scope.$watchCollection("[gridOptions.enableFiltering,gridOptions.enableSorting]",function(newValue,oldValue){columnDefSetup()});controller.setColumnOptions(columnIndex,scope.currentGridColumnDef);instanceElement.removeAttr(columnDirectiveAttribute)},post:function(scope,instanceElement,tAttrs,controller){if(scope.currentGridColumnDef){if(!scope.currentGridColumnDef.fieldName){throw"The column definition for trNgGrid must contain the field name"}if(scope.currentGridColumnDef.cellWidth){instanceElement.css("width",scope.currentGridColumnDef.cellWidth)}if(scope.currentGridColumnDef.cellHeight){instanceElement.css("height",scope.currentGridColumnDef.cellHeight)}if(instanceElement.text()==""){var cellContentsElement=$("<div>").addClass(cellCssClass);var cellContentsTitleSortElement=$("<div>").addClass(cellTitleSortCssClass).appendTo(cellContentsElement);$("<div>").addClass(titleCssClass).text(scope.currentGridColumnDef.displayName).appendTo(cellContentsTitleSortElement);$("<div>").attr(sortDirectiveAttribute,"").appendTo(cellContentsTitleSortElement);$("<div>").attr(filterColumnDirectiveAttribute,"").appendTo(cellContentsElement);instanceElement.append($compile(cellContentsElement)(scope))}}}}}}}]).directive(sortDirective,[function(){return{restrict:"A",replace:true,template:function(templateElement,tAttrs){return"<div ng-show='currentGridColumnDef.enableSorting' ng-click='toggleSorting(currentGridColumnDef.fieldName)' title='排序' class='"+sortCssClass+"'>"+"<div "+"ng-class=\"{'"+sortActiveCssClass+"':gridOptions.orderBy==currentGridColumnDef.fieldName,'"+sortInactiveCssClass+"':gridOptions.orderBy!=currentGridColumnDef.fieldName,'"+sortReverseCssClass+"':gridOptions.orderByReverse}\" "+" >"+"</div>"+"</div>"}}}]).directive(filterColumnDirective,[function(){return{restrict:"A",replace:true,template:function(templateElement,tAttrs){return"<div ng-show='currentGridColumnDef.enableFiltering' class='"+filterColumnCssClass+"'>"+"<div class='"+filterInputWrapperCssClass+"'>"+"<input class='form-control input-sm' type='text' ng-model='filter'/>"+"</div>"+"</div>"},link:function(scope,instanceElement,tAttrs,controller){}}}]).filter("paging",function(){return function(input,gridOptions){if(input)gridOptions.totalItems=input.length;if(!gridOptions.pageItems||!input||input.length==0)return input;if(!gridOptions.currentPage){gridOptions.currentPage=0}var startIndex=gridOptions.currentPage*gridOptions.pageItems;if(startIndex>=input.length){gridOptions.currentPage=0;startIndex=0}var endIndex=gridOptions.currentPage*gridOptions.pageItems+gridOptions.pageItems;return input.slice(startIndex,endIndex)}}).directive(bodyDirective,["$compile",function($compile){return{restrict:"A",scope:true,require:"^"+tableDirective,replace:false,compile:function(templateElement,tAttrs){var bodyTemplateRow=templateElement.children("tr");templateElement.contents().remove();return{post:function(scope,compiledInstanceElement,tAttrs,controller){scope.gridOptions=controller.gridOptions;scope.toggleItemSelection=function(item){return controller.toggleItemSelection(item)};var ngRepeatAttrValue="gridItem in gridOptions.items";if(scope.gridOptions.onDataRequired){}else{ngRepeatAttrValue+=" | filter:gridOptions.filterBy | filter:gridOptions.filterByFields | orderBy:gridOptions.orderBy:gridOptions.orderByReverse | paging:gridOptions"}bodyTemplateRow.attr("ng-repeat",ngRepeatAttrValue);if(!bodyTemplateRow.attr("ng-click")){bodyTemplateRow.attr("ng-click","toggleItemSelection(gridItem)")}bodyTemplateRow.attr("ng-class","{'"+selectedRowCssClass+"':gridOptions.selectedItems.indexOf(gridItem)>=0}");bodyTemplateRow.attr(rowPageItemIndexAttribute,"{{$index}}");angular.forEach(scope.gridOptions.gridColumnDefs,function(columnOptions,index){var cellTemplateElement=bodyTemplateRow.children("td:nth-child("+(index+1)+")");var cellTemplateFieldName=cellTemplateElement.attr("field-name");var createInnerCellContents=false;if(cellTemplateFieldName!==columnOptions.fieldName){createInnerCellContents=true;var newCellTemplateElement=$("<td>");if(cellTemplateElement.length==0)bodyTemplateRow.append(newCellTemplateElement);else cellTemplateElement.before(newCellTemplateElement);cellTemplateElement=newCellTemplateElement}else{createInnerCellContents=cellTemplateElement.text()==""}if(createInnerCellContents){var cellContentsElement=$("<div>").addClass(cellCssClass);if(columnOptions.fieldName){cellContentsElement.attr("field-name",columnOptions.fieldName);var cellContentsElementText="{{gridItem."+columnOptions.fieldName;if(columnOptions.displayFormat){if(columnOptions.displayFormat[0]!="|"&&columnOptions.displayFormat[0]!="."){cellContentsElementText+=" | "}cellContentsElementText+=columnOptions.displayFormat}cellContentsElementText+="}}";cellContentsElement.text(cellContentsElementText)}else{cellContentsElement.text("Invalid column match inside the table body")}cellTemplateElement.append(cellContentsElement)}if(columnOptions.displayAlign){cellTemplateElement.addClass("text-"+columnOptions.displayAlign)}if(columnOptions.cellWidth){cellTemplateElement.css("width",columnOptions.cellWidth)}if(columnOptions.cellHeight){cellTemplateElement.css("height",columnOptions.cellHeight)}});bodyTemplateRow.children("td["+columnDirectiveAttribute+"]").removeAttr(columnDirectiveAttribute);bodyTemplateRow.removeAttr(bodyDirectiveAttribute);compiledInstanceElement.append($compile(bodyTemplateRow)(scope))}}}}}]).directive(footerDirective,[function(){return{restrict:"A",scope:false,require:"^"+tableDirective,replace:true,template:'<div class="'+footerOpsContainerCssClass+'">'+"<span "+globalFilterDirectiveAttribute+'=""/>'+"<span "+pagerDirectiveAttribute+'=""/>'+"</div>"}}]).directive(globalFilterDirective,[function(){return{restrict:"A",replace:true,scope:true,require:"^"+tableDirective,template:function(templateElement,tAttrs){return'<span ng-show="gridOptions.enableFiltering" class="pull-left form-group">'+'<input class="form-control" type="text" ng-model="gridOptions.filterBy" placeholder="搜索"/>'+"</span>"},compile:function(templateElement,tAttrs){return{pre:function(scope,compiledInstanceElement,tAttrs,controller){scope.gridOptions=controller.gridOptions},post:function(scope,instanceElement,tAttrs,controller){}}}}}]).directive(pagerDirective,[function(){var setupScope=function(scope,controller){scope.gridOptions=controller.gridOptions;scope.isPaged=!!scope.gridOptions.pageItems;scope.totalItemsCount=typeof scope.gridOptions.totalItems!="undefined"&&scope.gridOptions.totalItems!=null?scope.gridOptions.totalItems:scope.gridOptions.items?scope.gridOptions.items.length:0;scope.startItemIndex=scope.isPaged?scope.gridOptions.pageItems*scope.gridOptions.currentPage:0;scope.endItemIndex=scope.isPaged?scope.startItemIndex+scope.gridOptions.pageItems-1:scope.totalItemsCount-1;if(scope.endItemIndex>=scope.totalItemsCount){scope.endItemIndex=scope.totalItemsCount-1}if(scope.endItemIndex<scope.startItemIndex){scope.endItemIndex=scope.startItemIndex}scope.pageCanGoBack=scope.isPaged&&scope.gridOptions.currentPage>0;scope.pageCanGoForward=scope.isPaged&&scope.endItemIndex<scope.totalItemsCount-1;scope.navigateNextPage=function($event){scope.gridOptions.currentPage=scope.gridOptions.currentPage+1;$event.preventDefault();$event.stopPropagation()};scope.navigatePrevPage=function($event){scope.gridOptions.currentPage=scope.gridOptions.currentPage-1;$event.preventDefault();$event.stopPropagation()}};return{restrict:"A",scope:true,require:"^"+tableDirective,template:function(templateElement,tAttrs){return'<span class="pull-right form-group">'+'<ul class="pagination">'+"<li>"+'<a href="#" ng-show="pageCanGoBack" ng-click="navigatePrevPage($event)" title="上一页">&lArr;</a>'+"</li>"+'<li class="disabled" style="white-space: nowrap;">'+'<span ng-hide="totalItemsCount">没有可以显示的项</span>'+'<span ng-show="totalItemsCount">'+"  显示{{startItemIndex+1}} - {{endItemIndex+1}}"+"<span>, 总计{{totalItemsCount}}</span>"+"</span>"+"</li>"+"<li>"+'<a href="#" ng-show="pageCanGoForward" ng-click="navigateNextPage($event)" title="下一页">&rArr;</a>'+"<li>"+"</ul>"+"</span>"},replace:true,link:{pre:function(scope,compiledInstanceElement,tAttrs,controller){setupScope(scope,controller)},post:function(scope,instanceElement,tAttrs,controller){scope.$watchCollection("[gridOptions.currentPage, gridOptions.items.length, gridOptions.totalItems, gridOptions.pageItems]",function(newValues,oldValues){setupScope(scope,controller)})}}}}])})(TrNgGrid||(TrNgGrid={}));